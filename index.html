<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <title>Kernel Crawler</title>
    <meta name="author" content="">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.min.js"></script>
    <style>
        .dataTables_filter {
            padding-right: 10px;
        }
        .btn {
            padding-bottom: 15px;
        }
    </style>
    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var arch = urlParams.get('arch');
        if (arch == null) {
            arch = "x86_64";
        };
        var target = urlParams.get('target')
        if (target == null) {
            if (arch == "x86_64") {
                target = "AmazonLinux";
            }
            if (arch == "aarch64") {
                target = "AmazonLinux2";
            }
        };
        var search = urlParams.get('search')
        if (search == null) {
            search = "";
        };
        $(document).ready(function() {
            $('#kernels').DataTable({
                "search": {"search": search },
                "paging": false,
                // "data" : data,
                "order": [[ 1, "desc" ]],
                ajax: {
                    url: 'https://raw.githubusercontent.com/falcosecurity/kernel-crawler/kernels/'+arch+'/list.json',
                    dataSrc: target,
                },
                columns : [
                    { "data" : "target"},
                    { "data" : "kernelrelease"},
                    { "data" : "kernelversion"},
                    {
                        "data": 'headers',
                        render: function (data, type) {
                            if (data === undefined) {
                                return '';
                            }
                            let s = '';
                            for (const value of Object.values(data)) {
                                s += '<a href="'+value+'" download="'+value+'"><i class="bi bi-download" style="margin-right: 8px;"></i></a>'
                            }
                            return s;
                        },
                    },
                    {
                        "data": 'kernelconfigdata',
                        render: function (data, type) {
                            if (data === undefined) {
                                return '';
                            }
                            return '<a href="data:application/octet-stream;charset=utf-8;base64,'+data+'" download="config.txt"><i class="bi bi-download"></a>'
                        },
                    },
                    { 
                        "data" : "kernelrelease",
                        render: function (data, type, row) {
                            return '<a href="?arch='+arch+'&target='+target+'&search='+data+'"><i class="bi bi-link"></i></a>';
                        }
                    },
                ]
            });
        });
    </script>
    </head>
    <body>
    <div>
        <img src="https://sysdig.com/wp-content/uploads/2018/10/Falco-horizontal-logo-teal_2x.png" height="55" alt="falco logo">
    </div>
    <div style="padding-left: 10px;">
        Architecture: <a href="?arch=x86_64" class="btn btn-link">x86_64</a><a href="?arch=aarch64" class="btn btn-link">aarch64</a> 
    </div>
    <div id="targets" style="padding-left: 10px;">
        Target:
    </div>
    <table id="kernels" class="table table-striped table-condensed" style="padding-left: 10px;">
        <thead>
            <tr>
                <th>Target</th>
                <th>Kernel Release</th> 
                <th>Kernel Version</th>
                <th>Headers</th>
                <th>Config</th>
                <th>Link</th>
            </tr>
        </thead>
    </table>
    </body>
    <script>
        $.getJSON('https://raw.githubusercontent.com/falcosecurity/kernel-crawler/kernels/'+arch+'/list.json', function(data) {
            for (var key in data) {
                var spanelement = document.createElement('span');
                spanelement.className = "btn btn-link";
                spanelement.style = "padding-bottom: 15px;";
                var aelement = document.createElement('a');
                var linkText = document.createTextNode(key);
                aelement.appendChild(linkText);
                aelement.title = key;
                aelement.href = "?target="+key+"&arch="+arch;
                spanelement.appendChild(aelement);
                document.getElementById("targets").appendChild(spanelement);
            }
        });
    </script>
</html>